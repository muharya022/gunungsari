{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jadwal Kegiatan</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .table thead {
            background-color: #198754; /* Hijau Bootstrap */
            color: white;
        }
        .btn-custom {
            transition: all 0.3s ease-in-out;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-success mb-4"><i class="bi bi-calendar-event"></i> Jadwal Kegiatan</h2>

    <div class="alert alert-info shadow-sm rounded" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>Catatan:</strong> Jika permohonan peminjaman disetujui, maka kegiatan akan otomatis muncul di jadwal. 
        Permohonan dapat disetujui dalam kurun waktu <strong>1x24 jam</strong>. <strong>Tolong di cek secara berkala!!</strong>
    </div>

    <!-- Tombol Tambah Jadwal -->
    {% if user.is_authenticated %}
    <a href="{% url 'tambah_jadwal' %}" class="btn btn-success mb-3 btn-custom">
        <i class="bi bi-plus-circle"></i> Tambah Jadwal
    </a>
    {% endif %}
    

    {% if jadwal %}
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-bordered table-hover align-middle">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Tanggal</th>
                        <th>Nama Kegiatan</th>
                        <th>Fasilitas</th>
                        <th>Waktu</th>
                        {% if user.is_authenticated %}
                        <th>Aksi</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for j in jadwal %}
                        <tr data-url="{% url 'jadwal_detail' j.id %}" style="cursor:pointer;">
                            <td>{{ forloop.counter }}</td>
                            <td>{{ j.tanggal|date:"d M Y" }}</td>
                            <td>{{ j.nama_kegiatan }}</td>
                            <td>
                                {% if j.fasilitas.all %}
                                    {% for f in j.fasilitas.all %}
                                        {{ f.nama }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <em>Tidak ada fasilitas</em>
                                {% endif %}
                            </td>
                            <td>{{ j.jam_mulai|time:"H:i" }} - {{ j.jam_selesai|time:"H:i" }}</td>
                            <td>
                                {% if user.is_authenticated %}
                                    <a href="#" data-url="{% url 'hapus_jadwal' j.id %}" class="btn btn-danger btn-sm btn-custom btn-hapus-jadwal">
                                        <i class="bi bi-trash"></i> Hapus
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-circle"></i> Tidak ada jadwal kegiatan.
        </div>
    {% endif %}

    <!-- Tombol Kembali -->
    <a href="/" class="btn btn-outline-secondary mt-3 btn-custom">
        <i class="bi bi-arrow-left"></i> Kembali
    </a>
</div>

<script>
document.querySelectorAll('tr[data-url]').forEach(row => {
  row.addEventListener('click', (event) => {
    // Cegah redirect kalau klik tombol hapus (atau elemen di dalamnya)
    if (event.target.closest('.btn-hapus-jadwal')) {
      return;
    }
    window.location.href = row.getAttribute('data-url');
  });
});

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-hapus-jadwal').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();  // cegah link langsung kehapus

      const url = this.getAttribute('data-url');

      Swal.fire({
        title: '<span style="font-size:16px;">Yakin ingin menghapus jadwal ini?</span>',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, hapus!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    });
  });
});
</script>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags }}' || 'info',
        title: 'Info',
        text: "{{ message.message|escapejs }}",
        confirmButtonText: 'OK'
      });
    {% endfor %}
  });
</script>
{% endif %}

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
